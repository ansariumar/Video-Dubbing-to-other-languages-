import torch
from TTS.api import TTS
import os
import time
from pydub import AudioSegment
from typing import TypedDict


class TranslationEntry(TypedDict):
    timestamp: tuple[float, float]
    text: str


# Get device
device = "cuda" if torch.cuda.is_available() else "cpu"

# Init TTS
tts = TTS("tts_models/multilingual/multi-dataset/xtts_v2").to(device)


output_dir = "tts_outputs"
os.makedirs(output_dir, exist_ok=True)

def text_to_speech(translated_chunk: list[TranslationEntry], speaker_wav:str="./audio_samples/president.wav", language:str="hi") -> None:
    
    for i, chunk in enumerate(translated_chunk):
        out_path = os.path.join(output_dir, f"chunk_{i}.wav")
    
        print(f"Generating audio for chunk {i}...", end="")
        tts.tts_to_file(
            text=chunk['text'],
            speaker_wav=speaker_wav,
            language=language,
            file_path=out_path
        )

def merge_audio_chunks_with_timestamps(translated_chunk: list[TranslationEntry], chunk_folder: str = "tts_outputs", output_path: str = "final_output.wav"):
    final_audio = AudioSegment.empty()

    for i, chunk in enumerate(translated_chunk):
        start_time_sec = chunk["timestamp"][0]
        if i == 0:
            prev_end_time_sec = 0.0
        else:
            prev_end_time_sec = translated_chunk[i - 1]["timestamp"][1]

        # Duration of silence between chunks
        silence_duration_ms = int((start_time_sec - prev_end_time_sec) * 1000)
        if silence_duration_ms > 0:
            final_audio += AudioSegment.silent(duration=silence_duration_ms)

        # Load the chunk audio
        chunk_path = os.path.join(chunk_folder, f"chunk_{i}.wav")
        chunk_audio = AudioSegment.from_wav(chunk_path)

        # Append to final audio
        final_audio += chunk_audio

    # Export the final merged audio
    final_audio.export(output_path, format="wav")
    print(f"Final audio saved to: {output_path}")

    

# chunk = [{'timestamp': (0.0, 4.0), 'text': 'इस व्याख्यान में हम एक नई विषयवस्तु शुरू करेंगे और विषय है'}, {'timestamp': (4.0, 12.0), 'text': 'नियमित अभिव्यक्तियाँ। तो, अब तक हमने कई भाषाओं और कुछ प्रकार के स्ट्रिंग्स को देखा है।'}, {'timestamp': (12.0, 19.0), 'text': 'स्वीकृत भाषाओं द्वारा। और अब तक, हमने उन स्ट्रिंग्स को दर्शाने का तरीका बस सरल का उपयोग करके था।'}, {'timestamp': (19.2, 24.0), 'text': 'अंग्रेजी भाषा। अब, नियमित अभिव्यक्तियाँ क्या हैं? नियमित अभिव्यक्तियाँ।'}, {'timestamp': (24.0, 31.26), 'text': 'ये कुछ स्ट्रिंग सेट को गणितीय तरीके से दर्शाने के लिए इस्तेमाल किए जाते हैं। तो, इसके बजाय'}, {'timestamp': (31.26, 36.24), 'text': 'सरल तरीके से उन्हें दर्शाने के, हम अब उन्हें वैसे ही दर्शा सकते हैं जैसा हमने पहले तक किया था, ये नियमित।'}, {'timestamp': (36.24, 41.84), 'text': 'अभिव्यक्तियाँ इस तरह से उपयोग किए जाते हैं ताकि हमारे स्ट्रिंग को बीजगणितीय तरीके से दर्शाया जा सके।'}, {'timestamp': (41.84, 47.14), 'text': 'तो, नियमित अभिव्यक्ति के बारे में अधिक जानने से पहले, कुछ बातें या नियम हैं जो आपको…'}, {'timestamp': (47.14, 50.0), 'text': 'हमें याद रखना होगा और देखते हैं कि वे क्या हैं।'}, {'timestamp': (50.0, 55.0), 'text': 'ठीक है, तो ये नियम या बिंदु हैं जिन्हें हमें नियमित अभिव्यक्तियों के बारे में याद रखना चाहिए।'}, {'timestamp': (55.0, 58.0), 'text': 'तो, चलो पहले बिंदु को देखते हैं। कोई भी टर्मिनल प्रतीक,'}, {'timestamp': (58.0, 66.0), 'text': 'मैं. यानी सिग्मा से संबंधित प्रतीक, जिसमें खाली और शून्य प्रतीक भी शामिल हैं, नियमित अभिव्यक्ति हैं। इसलिए, तक'}, {'timestamp': (66.0, 75.0), 'text': 'अब हमने कई प्रतीकों जैसे A, B, C और इसी तरह के कई को देखा है जिनका हम इनपुट और आउटपुट को दर्शाने के लिए उपयोग करते हैं।'}, {'timestamp': (75.0, 78.0), 'text': 'तो, ये सभी प्रतीक, जिन्हें टर्मिनल प्रतीक के रूप में जाना जाता है।'}, {'timestamp': (78.0, 83.0), 'text': 'शामिल हैं खाली और शून्य प्रतीक भी सभी नियमित अभिव्यक्तियाँ हैं।'}, {'timestamp': (83.0, 88.82), 'text': 'तो, यही पहली बात कहती है। अब, आइए दूसरी बात देखते हैं। द यूनियन'}, {'timestamp': (88.82, 99.0), 'text': 'दो नियमित अभिव्यक्तियों का संयोजन भी एक नियमित अभिव्यक्ति है। तो, मान लीजिए कि हमारे पास दो नियमित अभिव्यक्तियाँ हैं जिन्हें हम R1 और R2 कहते हैं।'}, {'timestamp': (99.0, 101.0), 'text': 'ये दो नियमित अभिव्यक्तियाँ हैं।\n'}, {'timestamp': (101.0, 112.0), 'text': 'और फिर इन नियमित अभिव्यक्तियों का संघ जो R1 प्लस R2 द्वारा दर्शाया गया है। यह भी एक नियमित अभिव्यक्ति है।'}, {'timestamp': (112.0, 119.0), 'text': 'तो, यदि r1 और r2 नियमित हैं, तो उनका संघ भी नियमित होगा। ठीक है, तो चलिए हम तीसरी बिंदु देखते हैं।'}, {'timestamp': (119.0, 127.16), 'text': 'दो नियमित अभिव्यक्तियों का संयोजन भी एक नियमित अभिव्यक्ति होती है। तो, मान लीजिए हम फिर से दो...\n'}, {'timestamp': (127.16, 138.2), 'text': 'नियमित अभिव्यक्तियाँ R1 और R2. फिर, इन दो नियमित अभिव्यक्तियों का संयोजन जो R1, R2 द्वारा दर्शाया जाता है, या आप इसे...\n'}, {'timestamp': (138.2, 144.0), 'text': 'यहां एक बिंदु उनके बीच डाल दिया। इसलिए, यह भी एक नियमित अभिव्यक्ति होगी।'}, {'timestamp': (144.0, 151.0), 'text': 'तो, अगर हमारे पास दो नियमित अभिव्यक्तियाँ हैं, तो उनका संयोजन हमेशा एक नियमित अभिव्यक्ति होगा।'}, {'timestamp': (151.0, 153.0), 'text': 'ठीक है, तो चलिए चौथे बिंदु पर आते हैं।'}, {'timestamp': (153.0, 163.0), 'text': 'यह पुनरावृत्ति या नियमित अभिव्यक्ति का समापन भी एक नियमित अभिव्यक्ति है। इसलिए, अगर हमारे पास एक नियमित अभिव्यक्ति, \n'}, {'timestamp': (163.0, 167.4), 'text': 'चलिए आर मान लेते हैं, और फिर आर का क्लोजर जो दर्शाया गया है'}, {'timestamp': (167.4, 175.0), 'text': 'बाय आर स्टार भी एक नियमित अभिव्यक्ति होगी। तो, क्या है खुलासा? मैंने पहले ही उल्लेख किया है।\n'}, {'timestamp': (175.0, 179.2), 'text': 'और हमने एक हमारे पिछले व्याख्यान में खुलासा पर चर्चा की, लेकिन मुझे...\n'}, {'timestamp': (179.2, 187.32), 'text': 'बस इसे फिर से दोहराओ। मान लो हमारे पास एक प्रतीक A है और फिर A स्टार से प्रतिनिधित्व किया गया क्लोजर।'}, {'timestamp': (187.32, 191.76), 'text': 'बन जाओ हर वो चीज़ जो तुम इस A का उपयोग करके बना सकते हो। इसलिए, इसमें शामिल है।\n'}, {'timestamp': (191.76, 196.0), 'text': 'खालील प्रतीक तसेच अ'}, {'timestamp': (196.0, 203.0), 'text': 'और एए, एए और इसी तरह। आप इस ए का उपयोग करके जो कुछ भी बना सकते हैं, वह एक अनंत सेट होगा।'}, {'timestamp': (203.0, 210.0), 'text': 'तो, यह A का क्लोजर है। तो, अगर A एक रेगुलर एक्सप्रेशन है, तो उसका क्लोजर भी एक रेगुलर एक्सप्रेशन होगा।'}, {'timestamp': (210.0, 213.0), 'text': 'तो, यह चौथी बात जो हमें बता रही है, वही है।\n'}, {'timestamp': (213.0, 223.64), 'text': 'और फिर, पाँचवाँ बिंदु कहता है कि सिग्मा पर नियमित अभिव्यक्ति वे हैं जो पुनरावर्ती रूप से आवेदन द्वारा प्राप्त किए जाते हैं।'}, {'timestamp': (223.64, 232.4), 'text': 'ऊपर दिए गए नियमों की एक या कई बार जाँच करें। तो, सिग्मा पर सभी नियमित अभिव्यक्तियाँ क्या हैं?'}, {'timestamp': (232.4, 240.34), 'text': 'वे बस नियमित अभिव्यक्तियाँ हैं जो इन नियमों को लागू करने से प्राप्त होती हैं जो ऊपर दिए गए हैं एक बार या।'}, {'timestamp': (240.34, 245.46), 'text': 'कई बार। इसलिए, हम देखते हैं कि जब हमारे पास नियमित अभिव्यक्तियाँ होती हैं, तो यदि हम "यूनियन" करते हैं,'}, {'timestamp': (245.46, 251.5), 'text': 'उन्हें या उनके संयोजन या उनके समापन से, आप नए नियमित अभिव्यक्तियाँ प्राप्त करते हैं। इसलिए, यह...\n'}, {'timestamp': (251.5, 257.18), 'text': 'पांचवीं बात हमें बताती है कि सिग्मा पर रेगुलर एक्सप्रेशन वे हैं जो लागू करके प्राप्त होते हैं।'}, {'timestamp': (257.18, 261.0), 'text': 'ये नियम जो ऊपर दिए गए हैं, एक बार या कई बार।\n'}, {'timestamp': (261.0, 264.0), 'text': 'तो, ये वो नियम हैं जिन्हें हमें रिवेलरी एक्सप्रेशन के बारे में याद रखना है।'}, {'timestamp': (264.0, 268.72), 'text': 'तो, अगले लेक्चर में हम उदाहरण लेंगे और हम इसे समझ जाएंगे।\n'}, {'timestamp': (268.72, 278.06), 'text': 'एक बेहतर तरीका। तो, देखने के लिए धन्यवाद और अगले में मिलते हैं।'}]
# text_to_speech(chunk)